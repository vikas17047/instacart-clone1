<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Instacart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p-color: #008060; --bg: #ffffff; --text: #000000; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); padding-bottom: 100px; }
        .nav-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--bg); z-index: 100; border-bottom: 1px solid #eee; }
        .p-main-img { width: 100%; height: 400px; object-fit: cover; }
        .p-info-sec { padding: 20px; }
        .p-price { font-size: 1.6rem; color: var(--p-color); font-weight: 800; margin: 12px 0; }
        .bottom-bar { position: fixed; bottom: 0; width: 100%; display: flex; padding: 15px 20px; gap: 12px; background: var(--bg); border-top: 1px solid #eee; box-sizing: border-box; }
        .btn-cart { flex: 1; padding: 16px; border: 2px solid var(--p-color); background: transparent; color: var(--p-color); border-radius: 12px; font-weight: 800; cursor: pointer; }
        .btn-buy { flex: 1; padding: 16px; background: var(--p-color); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>
    <div class="nav-header">
        <i class="fas fa-arrow-left" onclick="window.history.back()"></i>
        <b>Product Details</b>
        <i class="fas fa-share-alt"></i>
    </div>
    <img id="pImg" class="p-main-img" src="">
    <div class="p-info-sec">
        <h1 id="pName">Loading...</h1>
        <div id="pPrice" class="p-price">â‚¹--</div>
        <p id="pDesc">Fetching details...</p>
    </div>
    <div class="bottom-bar">
        <button class="btn-cart" onclick="addToCart()">ADD TO CART</button>
        <button class="btn-buy" onclick="buyNow()">BUY NOW</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqh5b-p5dsiU6AtkWRbyD0rSUD62Izqeg",
            authDomain: "instacart-clone-91062.firebaseapp.com",
            projectId: "instacart-clone-91062",
            storageBucket: "instacart-clone-91062.firebasestorage.app",
            messagingSenderId: "232217818928",
            appId: "1:232217818928:web:e05efedfda36263f6cfaf5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const sellerId = urlParams.get('seller'); 
        let currentProduct = null;

        async function loadDetails() {
            if(!productId) return;
            const pSnap = await getDoc(doc(db, "products", productId));
            if(pSnap.exists()) {
                currentProduct = { id: pSnap.id, ...pSnap.data() };
                document.getElementById('pName').innerText = currentProduct.name;
                document.getElementById('pPrice').innerText = "â‚¹" + currentProduct.price;
                document.getElementById('pImg').src = currentProduct.image;
                document.getElementById('pDesc').innerText = currentProduct.description || "No description.";
                
                // Theme Load logic
                if(sellerId) {
                    const dSnap = await getDoc(doc(db, "store_designs", sellerId));
                    if(dSnap.exists()) {
                        document.documentElement.style.setProperty('--p-color', dSnap.data().pColor || '#008060');
                    }
                }
            }
        }

        window.addToCart = () => {
            if(!currentProduct || !sellerId) { alert("Error: Missing Product/Seller info"); return; }
            
            const cartKey = `myCart_${sellerId}`;
            let cart = JSON.parse(localStorage.getItem(cartKey)) || [];
            
            // Quantity logic: Agar item pehle se hai toh qty barhao
            const existingIndex = cart.findIndex(item => item.id === currentProduct.id);
            if (existingIndex > -1) {
                cart[existingIndex].qty += 1;
            } else {
                cart.push({ ...currentProduct, qty: 1, img: currentProduct.image });
            }
            
            localStorage.setItem(cartKey, JSON.stringify(cart));
            alert("Added to cart! ðŸ›ï¸");
            window.location.href = `cart.html?seller=${sellerId}`;
        };

        window.buyNow = () => {
            if(!currentProduct || !sellerId) return;
            const cartKey = `myCart_${sellerId}`;
            localStorage.setItem(cartKey, JSON.stringify([{ ...currentProduct, qty: 1, img: currentProduct.image }]));
            localStorage.setItem('cartTotal', currentProduct.price);
            window.location.href = `checkout.html?seller=${sellerId}`; 
        };
        loadDetails();
    </script>
</body>
</html>
