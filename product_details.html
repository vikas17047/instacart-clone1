<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Instacart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p-color: #008060; --bg: #ffffff; --text: #000000; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); padding-bottom: 120px; }
        .nav-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--bg); z-index: 100; border-bottom: 1px solid #eee; }
        .p-main-img { width: 100%; height: 400px; object-fit: cover; }
        .p-info-sec { padding: 20px; }
        .p-price { font-size: 1.6rem; color: var(--p-color); font-weight: 800; margin: 12px 0; }
        
        .qty-selector { display: flex; align-items: center; gap: 20px; margin: 20px 0; padding: 10px; background: #f9f9f9; border-radius: 8px; width: fit-content; }
        .qty-btn { width: 35px; height: 35px; border: 1px solid #ddd; background: white; border-radius: 50%; font-size: 1.2rem; cursor: pointer; font-weight: bold; }
        .qty-val { font-weight: 800; font-size: 1.1rem; }

        .bottom-bar { position: fixed; bottom: 0; width: 100%; display: flex; padding: 15px 20px; gap: 12px; background: var(--bg); border-top: 1px solid #eee; box-sizing: border-box; }
        .btn-cart { flex: 1; padding: 16px; border: 2px solid var(--p-color); background: transparent; color: var(--p-color); border-radius: 12px; font-weight: 800; cursor: pointer; }
        .btn-buy { flex: 2; padding: 16px; background: var(--p-color); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>
    <div class="nav-header">
        <i class="fas fa-arrow-left" onclick="window.history.back()"></i>
        <b>Product Details</b>
        <i class="fas fa-share-alt"></i>
    </div>
    
    <img id="pImg" class="p-main-img" src="">
    
    <div class="p-info-sec">
        <h1 id="pName">Loading...</h1>
        <div id="pPrice" class="p-price">₹--</div>
        
        <div style="font-weight: 700; font-size: 0.9rem; color: #666;">SELECT QUANTITY</div>
        <div class="qty-selector">
            <button class="qty-btn" onclick="changeQty(-1)">-</button>
            <span id="qtyDisplay" class="qty-val">1</span>
            <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>

        <p id="pDesc">Fetching details...</p>
    </div>

    <div class="bottom-bar">
        <button class="btn-cart" onclick="handleCartAction(false)">ADD TO CART</button>
        <button class="btn-buy" onclick="handleCartAction(true)">BUY NOW</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqh5b-p5dsiU6AtkWRbyD0rSUD62Izqeg",
            authDomain: "instacart-clone-91062.firebaseapp.com",
            projectId: "instacart-clone-91062",
            storageBucket: "instacart-clone-91062.firebasestorage.app",
            messagingSenderId: "232217818928",
            appId: "1:232217818928:web:e05efedfda36263f6cfaf5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const sellerId = urlParams.get('seller'); 
        
        let currentProduct = null;
        let selectedQty = 1;
        let loggedUser = null;

        // Login Status Check
        onAuthStateChanged(auth, (user) => {
            loggedUser = user;
        });

        async function loadDetails() {
            if(!productId) return;
            const pSnap = await getDoc(doc(db, "products", productId));
            if(pSnap.exists()) {
                currentProduct = { id: pSnap.id, ...pSnap.data() };
                document.getElementById('pName').innerText = currentProduct.name;
                document.getElementById('pPrice').innerText = "₹" + currentProduct.price;
                document.getElementById('pImg').src = currentProduct.image;
                document.getElementById('pDesc').innerText = currentProduct.description || "No description.";
                
                if(sellerId) {
                    const dSnap = await getDoc(doc(db, "store_designs", sellerId));
                    if(dSnap.exists()) {
                        document.documentElement.style.setProperty('--p-color', dSnap.data().pColor || '#008060');
                    }
                }
            }
        }

        window.changeQty = (val) => {
            selectedQty += val;
            if(selectedQty < 1) selectedQty = 1;
            document.getElementById('qtyDisplay').innerText = selectedQty;
        }

        // Logic to Handle Login + Cart
        window.handleCartAction = async (isBuyNow) => {
            if(!currentProduct || !sellerId) return;

            // 1. Agar login nahi hai, toh Google Popup dikhao
            if(!loggedUser) {
                try {
                    const result = await signInWithPopup(auth, provider);
                    loggedUser = result.user;
                } catch (error) {
                    alert("Login required to continue!");
                    return;
                }
            }

            // 2. Login hone ke baad aage badho
            const cartKey = `myCart_${sellerId}`;
            
            if(isBuyNow) {
                const singleItem = [{ ...currentProduct, qty: selectedQty, img: currentProduct.image }];
                localStorage.setItem('temp_buy_now', JSON.stringify(singleItem));
                window.location.href = `checkout.html?seller=${sellerId}&mode=direct`;
            } else {
                let cart = JSON.parse(localStorage.getItem(cartKey)) || [];
                const existingIndex = cart.findIndex(item => item.id === currentProduct.id);
                if (existingIndex > -1) {
                    cart[existingIndex].qty += selectedQty;
                } else {
                    cart.push({ ...currentProduct, qty: selectedQty, img: currentProduct.image });
                }
                localStorage.setItem(cartKey, JSON.stringify(cart));
                window.location.href = `cart.html?seller=${sellerId}`;
            }
        };

        loadDetails();
    </script>
</body>
</html>
