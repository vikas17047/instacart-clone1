<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Instacart</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f6f6f7; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding-bottom: 30px; }
        .container { padding: 15px; max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; }
        .total { font-weight: 800; font-size: 1.1rem; border-top: 1px solid #eee; pt: 10px; }
        .pay-btn { width: 100%; background: #008060; color: white; border: none; padding: 16px; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 1rem; }
        #shippingStatus { font-size: 0.75rem; color: #008060; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="margin-bottom: 20px;"><i class="fas fa-shopping-bag"></i> Checkout</h3>

    <div class="card">
        <b style="font-size: 0.9rem;">Shipping Address</b>
        <input type="text" id="custName" placeholder="Full Name">
        <input type="number" id="custPhone" placeholder="Mobile Number">
        <textarea id="custAddr" rows="3" placeholder="Flat no, Street, City, State, Pincode" oninput="calculateShipping()"></textarea>
        <div id="shippingStatus">Enter address with 6-digit pincode for delivery rate...</div>
    </div>

    <div class="card">
        <b style="font-size: 0.9rem; display: block; margin-bottom: 15px;">Order Summary</b>
        <div class="row"><span>Item Total</span><span id="itemTotal">â‚¹0.00</span></div>
        <div class="row"><span>Shipping Charges</span><span id="shipCharge">â‚¹0.00</span></div>
        <div class="row total"><span>Grand Total</span><span id="grandTotal">â‚¹0.00</span></div>
    </div>

    <button class="pay-btn" onclick="placeOrder()">PAY & PLACE ORDER</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqh5b-p5dsiU6AtkWRbyD0rSUD62Izqeg",
        authDomain: "instacart-clone-91062.firebaseapp.com",
        projectId: "instacart-clone-91062",
        storageBucket: "instacart-clone-91062.firebasestorage.app",
        messagingSenderId: "232217818928",
        appId: "1:232217818928:web:e05efedfda36263f6cfaf5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let cartTotal = 0;
    let currentWeight = 500; // Default weight
    let sellerPincode = "";

    // ðŸš€ Shiprocket Credentials
    const API_USER = "vikas17047@gmail.com";
    const API_PASS = "&Ot0^Vbz#9ccEKK8p6S^lrDgA*et17g1";

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            loadCartData();
        } else { window.location.href = 'login.html'; }
    });

    async function loadCartData() {
        // Logic to get cart from LocalStorage/Firebase
        const cart = JSON.parse(localStorage.getItem('instacart_cart')) || [];
        cartTotal = cart.reduce((sum, item) => sum + Number(item.price), 0);
        document.getElementById('itemTotal').innerText = `â‚¹${cartTotal}`;
        document.getElementById('grandTotal').innerText = `â‚¹${cartTotal}`;
        
        // Load first item's weight & seller details
        if(cart.length > 0) {
            const prodSnap = await getDoc(doc(db, "products", cart[0].id));
            if(prodSnap.exists()) currentWeight = prodSnap.data().weight || 500;

            const sellerSnap = await getDoc(doc(db, "seller_identity", cart[0].sellerId));
            if(sellerSnap.exists()) sellerPincode = sellerSnap.data().sPin;
        }
    }

    // ðŸšš REAL-TIME SHIPPING RATE
    window.calculateShipping = async () => {
        const addr = document.getElementById('custAddr').value;
        const pinMatch = addr.match(/\b\d{6}\b/);
        
        if (pinMatch && sellerPincode) {
            const destPin = pinMatch[0];
            document.getElementById('shippingStatus').innerText = "Calculating delivery rate...";
            
            try {
                // 1. Get Token
                const authRes = await fetch('https://apiv2.shiprocket.in/v1/external/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: API_USER, password: API_PASS })
                });
                const authData = await authRes.json();
                const token = authData.token;

                // 2. Get Rate
                const rateRes = await fetch(`https://apiv2.shiprocket.in/v1/external/courier/serviceability?pickup_postcode=${sellerPincode}&delivery_postcode=${destPin}&weight=${currentWeight/1000}&cod=0`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const rateData = await rateRes.json();
                
                if(rateData.status === 200) {
                    const rate = rateData.data.available_courier_companies[0].rate;
                    document.getElementById('shipCharge').innerText = `â‚¹${rate}`;
                    document.getElementById('grandTotal').innerText = `â‚¹${Number(cartTotal) + Number(rate)}`;
                    document.getElementById('shippingStatus').innerText = "Delivery rate updated! âœ…";
                }
            } catch (e) { 
                document.getElementById('shippingStatus').innerText = "Error calculating rate.";
            }
        }
    };

    window.placeOrder = async () => {
        // Purana order placing logic yahan add karein
        alert("Redirecting to Payment...");
    };
</script>
</body>
</html>
